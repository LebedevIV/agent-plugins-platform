# Контекст Проекта - Видение и Архитектура

## Видение Проекта

### Цель
Agent-Plugins-Platform (APP) - это браузерное расширение, которое позволяет выполнять Python плагины в браузере с использованием Pyodide и протокола MCP (Model Context Protocol). Проект фокусируется на безопасности, производительности и удобстве разработки.

### Ключевые Принципы
- **Безопасность**: Полная изоляция плагинов в sandbox
- **Производительность**: Оптимизированная загрузка и выполнение
- **UX**: Интуитивный интерфейс с автоматическим сохранением состояния
- **Расширяемость**: Модульная архитектура для легкого добавления плагинов
- **Умный UX**: Сайдпанель показывается только на релевантных сайтах

## Архитектура

### Основные Компоненты

#### 1. Hooks Архитектура (НОВОЕ)
- **useChromeApi.ts**: Централизованное управление Chrome API
- **useMessageHandler.ts**: Обработка сообщений между компонентами
- **usePluginManager.ts**: Управление жизненным циклом плагинов
- **useBackgroundScript.ts**: Основная логика background script
- **utils/validation.ts**: Валидация данных
- **utils/logging.ts**: Централизованное логирование

#### 2. Plugin Manager (`core/plugin-manager.js`)
- Управляет жизненным циклом плагинов
- Координирует загрузку и выполнение
- Обеспечивает изоляцию между плагинами

#### 3. Host API (`core/host-api.js`)
- Предоставляет доступ к браузерным API для Python
- Обеспечивает безопасный интерфейс
- Валидирует все запросы

#### 4. Workflow Engine (`core/workflow-engine.js`)
- Выполняет рабочие процессы плагинов
- Управляет последовательностью операций
- Обрабатывает ошибки и откаты

#### 5. MCP Bridge (`bridge/mcp-bridge.js`)
- Обеспечивает коммуникацию между JavaScript и Python
- Реализует протокол MCP
- Обрабатывает сериализацию данных

#### 6. Pyodide Worker (`bridge/pyodide-worker.js`)
- Изолированное выполнение Python кода
- Управляет Pyodide runtime
- Обеспечивает sandboxing

### Умная Логика Показа Сайдпанели (НОВОЕ)
- **Анализ совместимости**: Автоматическое определение сайтов, поддерживаемых плагинами
- **Текущие сайты**: ozon.ru (ozon-analyzer), google.com (google-helper)
- **Graceful fallback**: Корректная обработка сайтов без плагинов
- **Динамическое обновление**: Автоматическое обновление при изменении плагинов

### Структура Плагина
```
public/plugins/plugin-name/
├── manifest.json      # Метаданные и разрешения плагина
├── mcp_server.py      # Python реализация MCP протокола
├── workflow.json      # Определение рабочего процесса
└── icon.svg          # Иконка плагина
```

### Поток Коммуникации
1. UI → Plugin Manager → MCP Bridge → Pyodide Worker → Python Plugin
2. Python Plugin → Host API → Browser APIs
3. Результаты возвращаются по тому же пути

## Технический Стек

### Frontend
- **JavaScript/TypeScript**: Основной язык разработки
- **ES6+**: Современные возможности языка
- **Async/Await**: Асинхронное программирование
- **Web Workers**: Изоляция выполнения

### Backend (Python)
- **Pyodide**: Python в браузере
- **MCP Protocol**: Стандартизированная коммуникация
- **Async Python**: Асинхронное выполнение

### Браузерные API
- **Chrome Extensions API**: Manifest V3
- **Sidebar API**: Боковая панель
- **Storage API**: Локальное хранение
- **Tabs API**: Управление вкладками

### AI Интеграция
- **Google Gemini API**: Многоуровневая система моделей
  - Gemini Flash: Базовая аналитика
  - Gemini Pro: Детальное сравнение
  - Gemini 2.5 Pro: Глубокий анализ
- **Fallback Strategy**: Автоматический переход между моделями
- **Rate Limiting**: Обработка лимитов API

## Структура Файлов

### Основные Файлы
- `manifest.json`: Конфигурация расширения (Manifest V3)
- `package.json`: Зависимости Node.js и скрипты
- `vite.config.js`: Конфигурация сборки
- `index.html`: Главная точка входа приложения
- `test-harness.js`: Интерфейс тестирования для разработки

### Разработка Плагинов
- Плагины создаются в `public/plugins/`
- Следуют соглашению именования: `plugin-name/`
- Включают полные метаданные в manifest.json
- Реализуют MCP протокол в mcp_server.py
- Определяют рабочие процессы в workflow.json

### Сборка и Развертывание
- `npm run dev`: Для разработки
- `npm run build`: Для продакшена
- Тестирование расширения в режиме разработчика браузера
- Валидация безопасности плагинов перед распространением

## Общие Паттерны

### Структура Манифеста Плагина
```json
{
  "name": "Plugin Name",
  "version": "1.0.0",
  "description": "Plugin description",
  "main_server": "mcp_server.py",
  "host_permissions": ["*://*.example.com/*"],
  "permissions": ["activeTab", "scripting"]
}
```

### Формат MCP Сообщения
```javascript
{
  "type": "request|response|notification",
  "id": "unique-message-id",
  "method": "function-name",
  "params": { /* parameters */ },
  "result": { /* result */ }
}
```

### Шаблон Python Плагина
```python
import sys
import json
from typing import Any, Dict

async def main():
    line = sys.stdin.readline()
    request = json.loads(line)
    
    # Обработка запроса
    result = await process_request(request)
    
    # Отправка ответа
    response = {"result": result}
    sys.stdout.write(json.dumps(response) + '\n')

async def process_request(request: Dict[str, Any]) -> Dict[str, Any]:
    # Логика плагина здесь
    return {"status": "success"}
```

## Безопасность

### Валидация Плагинов
- Проверка манифестов плагинов
- Валидация требований разрешений
- Сканирование на вредоносный код
- Проверка подписей плагинов

### Runtime Безопасность
- Принуждение границ sandbox
- Валидация всех входных данных
- Мониторинг поведения плагинов
- Реализация rate limiting

### Защита Данных
- Санитизация всех пользовательских данных
- Шифрование чувствительной информации
- Реализация безопасной коммуникации
- Аудит паттернов доступа к данным

## Производительность

### Оптимизация Запуска
- Ленивая загрузка Pyodide runtime
- Кэширование манифестов плагинов
- Оптимизация размера бандла
- Использование service worker кэширования

### Runtime Оптимизация
- Реализация кэширования результатов плагинов
- Оптимизация использования памяти
- Использование эффективных структур данных
- Минимизация cross-worker коммуникации

### Управление Памятью
- Очистка ресурсов WebWorker
- Мониторинг использования памяти
- Реализация подсказок для garbage collection
- Ограничение одновременного выполнения плагинов

## Тестирование и Отладка

### Тестовая страница (НОВОЕ - v0.9.4)
- **Изолированная среда**: Тестовая страница работает независимо от production
- **Прокси Chrome API**: Content script обеспечивает доступ к Chrome API
- **Обработка ошибок**: Graceful handling всех возможных сбоев
- **Логирование**: Подробная диагностика проблем
- **Автоматизация**: Возможность интеграции с CI/CD

### Ключевые проблемы и решения
1. **Content Script не загружается**: Использование postMessage вместо inline скриптов
2. **Chrome API недоступен**: Прокси через content script
3. **Sidebar не открывается**: Ограничения Chrome API на автоматическое открытие
4. **Ошибки соединения**: Обработка chrome.runtime.lastError

### Архитектура тестирования
```
Тестовый сервер (test-server.js) → Тестовая страница (test-page.html) → Content Script → Background Script
```

### Процесс тестирования
1. Запуск тестового сервера: `node test-server.js`
2. Открытие тестовой страницы: `http://localhost:3000/test-page.html`
3. Проверка статуса расширения и функций
4. Отладка через DevTools

### Лучшие практики
- Изоляция тестов от production кода
- Подробное логирование для диагностики
- Graceful degradation при сбоях
- Обработка всех типичных ошибок browser extension

## Заключение

---

## 🚀 Система Быстрых Команд AI (НОВОЕ - v1.0.0)

### Назначение
Система для инициации процесса самосохранения и восстановления AI между сессиями с максимальной доступностью и надежностью.

### Архитектура
- **Локальные файлы**: `AI_COMMANDS.md`, `memory-bank/quick-commands.md`
- **Внешние ссылки**: Gist файлы для резервного доступа
- **Интеграция**: Ссылки во всех memory-bank файлах
- **README**: Раздел с командами для AI

### Компоненты

#### 1. AI_COMMANDS.md
- Краткая памятка в корне проекта
- Основные команды для самосохранения и восстановления
- Ссылки на подробную документацию

#### 2. memory-bank/quick-commands.md
- Подробное руководство с командами
- Объяснение процесса самосохранения и восстановления
- Альтернативные варианты команд
- Полезные ссылки

#### 3. Внешние ссылки
- [🚀 Быстрые команды](https://gist.github.com/LebedevIV/6386d4c8a743dbfd1d3c7a3afdb5cb2c/raw/6df6ab34e7aafeec1a5e4d7cebd50fc44101d3ec/quick-commands.md)
- Обеспечивают доступ к командам из любого места
- Fallback при недоступности локальных файлов

### Канонические команды

#### Самосохранение:
```
Пожалуйста, выполни процесс самосохранения и архивации знаний
```

#### Восстановление:
```
Пожалуйста, восстанови контекст из memory-bank и продолжи работу с проектом Agent-Plugins-Platform
```

### Принципы дизайна
- **Дублирование**: Команды доступны локально и через внешние ссылки
- **Надежность**: Fallback механизмы при недоступности файлов
- **Удобство**: Быстрый доступ из любого места
- **Синхронизация**: Актуальность всех ссылок и файлов 